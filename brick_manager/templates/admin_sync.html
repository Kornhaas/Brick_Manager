<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Sync with Rebrickable</title>
    
    
    <!-- Favicon -->
    {% include "favicon_links.html" %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .sync-card {
            transition: all 0.3s ease;
        }

        .sync-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .sync-card.disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .status-icon {
            font-size: 1.2em;
            margin-right: 0.5rem;
        }

        .loading-spinner {
            display: none;
        }

        .sync-result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.375rem;
            display: none;
        }

        .token-status {
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 2rem;
        }
    </style>
</head>

<body>
    <!-- Include the navigation bar -->
    {% include 'navbar.html' %}

    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Administration - Rebrickable Synchronization</h1>
        </div>

        <!-- Token Status Section -->
        {% if not tokens_configured %}
        <div class="token-status bg-danger text-white">
            <h5><i class="bi bi-exclamation-triangle-fill status-icon"></i>Configuration Required</h5>
            <p class="mb-0">
                Rebrickable synchronization is disabled because API credentials are not configured.
                {% if not user_token_exists and not api_key_exists %}
                Please configure both your Rebrickable User Token and API Key.
                {% elif not user_token_exists %}
                Please configure your Rebrickable User Token.
                {% elif not api_key_exists %}
                Please configure your Rebrickable API Key.
                {% endif %}
            </p>
            <p class="mb-0 mt-2">
                <small>Go to Settings to configure your Rebrickable credentials.</small>
            </p>
        </div>
        {% else %}
        <div class="token-status bg-success text-white">
            <h5><i class="bi bi-check-circle-fill status-icon"></i>Ready for Synchronization</h5>
            <p class="mb-0">Rebrickable API credentials are configured and ready to use.</p>
        </div>
        {% endif %}

        <!-- Sync Options -->
        <div class="row">
            <!-- Missing Parts Sync -->
            <div class="col-md-6 mb-4">
                <div class="card sync-card h-100 {% if not tokens_configured %}disabled{% endif %}">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-arrow-repeat status-icon text-primary"></i>
                            Sync Missing Parts
                        </h5>
                        <p class="card-text">
                            Synchronize your missing parts with Rebrickable's Lost Parts feature. 
                            This will find and add missing parts to your Rebrickable account for easy tracking.
                        </p>
                        
                        <!-- Batch Size Selection -->
                        <div class="mb-3">
                            <label for="missing-parts-batch-size" class="form-label">Batch Size</label>
                            <select id="missing-parts-batch-size" class="form-select">
                                <option value="">Auto (Recommended)</option>
                                <option value="100">100 parts</option>
                                <option value="200">200 parts</option>
                                <option value="500">500 parts</option>
                                <option value="1000">1000 parts</option>
                            </select>
                            <div class="form-text">
                                Auto mode selects optimal batch size based on your collection size.
                            </div>
                        </div>

                        <button id="sync-missing-parts-btn" class="btn btn-primary" onclick="syncMissingParts()" 
                                {% if not tokens_configured %}disabled{% endif %}>
                            <span id="missing-parts-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            <span id="missing-parts-text">Start Sync</span>
                        </button>
                        
                        <div id="missing-parts-result" class="sync-result"></div>
                    </div>
                </div>
            </div>

            <!-- User Sets Sync -->
            <div class="col-md-6 mb-4">
                <div class="card sync-card h-100 {% if not tokens_configured %}disabled{% endif %}">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-collection status-icon text-success"></i>
                            Sync User Sets
                        </h5>
                        <p class="card-text">
                            Synchronize your local set collection with a "Brick_Manager" list on Rebrickable. 
                            The list will be created if it doesn't exist, and kept in sync with your local collection.
                            Quantities are automatically handled - if you have multiple copies of the same set locally,
                            the correct quantity will be set on Rebrickable.
                        </p>
                        
                        <div class="mb-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                This will create or update the "Brick_Manager" list on your Rebrickable account
                                to match your local set collection, including proper quantities for duplicate sets.</small>
                        </div>

                        <button id="sync-user-sets-btn" class="btn btn-success" onclick="syncUserSets()" 
                                {% if not tokens_configured %}disabled{% endif %}>
                            <span id="user-sets-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            <span id="user-sets-text">Start Sync</span>
                        </button>
                        
                        <div id="user-sets-result" class="sync-result"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scheduled Sync Status -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-clock status-icon text-info"></i>
                            Automatic Synchronization
                        </h5>
                        <p class="card-text">
                            Automatic synchronization runs every 6 hours to keep your Rebrickable account 
                            up to date with your local collection.
                        </p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Missing Parts Sync:</strong>
                                <span id="missing-parts-schedule-status" class="badge bg-info">Every 6 hours</span>
                            </div>
                            <div class="col-md-6">
                                <strong>User Sets Sync:</strong>
                                <span id="user-sets-schedule-status" class="badge bg-info">Every 6 hours</span>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                Scheduled tasks will only run when API credentials are properly configured.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Sync JavaScript -->
    <script>
        // Global variables
        const tokensConfigured = {{ 'true' if tokens_configured else 'false' }};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            if (tokensConfigured) {
                updateScheduleStatus();
            }
        });

        function updateScheduleStatus() {
            // This could be enhanced to check actual scheduler status
            // For now, just show static status
            const missingPartsStatus = document.getElementById('missing-parts-schedule-status');
            const userSetsStatus = document.getElementById('user-sets-schedule-status');
            
            if (tokensConfigured) {
                missingPartsStatus.textContent = 'Active - Every 6 hours';
                missingPartsStatus.className = 'badge bg-success';
                userSetsStatus.textContent = 'Active - Every 6 hours';
                userSetsStatus.className = 'badge bg-success';
            } else {
                missingPartsStatus.textContent = 'Disabled - No API credentials';
                missingPartsStatus.className = 'badge bg-warning';
                userSetsStatus.textContent = 'Disabled - No API credentials';
                userSetsStatus.className = 'badge bg-warning';
            }
        }

        function syncMissingParts() {
            if (!tokensConfigured) {
                alert('Please configure Rebrickable API credentials first.');
                return;
            }

            const button = document.getElementById('sync-missing-parts-btn');
            const spinner = document.getElementById('missing-parts-spinner');
            const text = document.getElementById('missing-parts-text');
            const result = document.getElementById('missing-parts-result');
            const batchSizeSelect = document.getElementById('missing-parts-batch-size');
            
            // Show loading state
            button.disabled = true;
            spinner.classList.remove('d-none');
            text.textContent = 'Syncing...';
            result.style.display = 'none';
            
            // Get selected batch size
            const batchSize = batchSizeSelect.value ? parseInt(batchSizeSelect.value) : null;
            
            // Prepare request body
            const requestBody = {};
            if (batchSize) {
                requestBody.batch_size = batchSize;
            }
            
            fetch('/admin/sync/missing_parts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSyncResult(result, 'success', formatMissingPartsResult(data));
                } else {
                    showSyncResult(result, 'danger', 'Sync failed: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error during missing parts sync:', error);
                showSyncResult(result, 'danger', 'Error during sync: ' + error.message);
            })
            .finally(() => {
                // Reset button state
                button.disabled = false;
                spinner.classList.add('d-none');
                text.textContent = 'Start Sync';
            });
        }

        function syncUserSets() {
            if (!tokensConfigured) {
                alert('Please configure Rebrickable API credentials first.');
                return;
            }

            const button = document.getElementById('sync-user-sets-btn');
            const spinner = document.getElementById('user-sets-spinner');
            const text = document.getElementById('user-sets-text');
            const result = document.getElementById('user-sets-result');
            
            // Show loading state
            button.disabled = true;
            spinner.classList.remove('d-none');
            text.textContent = 'Syncing...';
            result.style.display = 'none';
            
            fetch('/admin/sync/user_sets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSyncResult(result, 'success', formatUserSetsResult(data));
                } else {
                    showSyncResult(result, 'danger', 'Sync failed: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error during user sets sync:', error);
                showSyncResult(result, 'danger', 'Error during sync: ' + error.message);
            })
            .finally(() => {
                // Reset button state
                button.disabled = false;
                spinner.classList.add('d-none');
                text.textContent = 'Start Sync';
            });
        }

        function showSyncResult(resultElement, type, message) {
            resultElement.className = `sync-result alert alert-${type}`;
            resultElement.innerHTML = message;
            resultElement.style.display = 'block';
        }

        function formatMissingPartsResult(data) {
            const summary = data.summary || {};
            let html = `<h6>Missing Parts Sync Complete</h6>`;
            
            if (summary.message) {
                html += `<p>${summary.message}</p>`;
            }
            
            // Handle rate limiting feedback
            if (summary.rate_limited_count && summary.rate_limited_count > 0) {
                html += `<div class="alert alert-warning mb-2">
                    <small><i class="bi bi-clock"></i> <strong>Rate Limited:</strong> 
                    ${summary.rate_limited_count} parts were rate limited by Rebrickable's API. 
                    These will be automatically synced during the next scheduled run (every 6 hours).</small>
                </div>`;
            }
            
            if (summary.total_local) {
                html += `<ul class="mb-0">`;
                html += `<li>Total missing parts found: ${summary.total_local}</li>`;
                if (summary.sample_processed) {
                    html += `<li>Parts processed in this batch: ${summary.sample_processed}</li>`;
                }
                if (summary.to_add !== undefined) {
                    html += `<li>Parts successfully added to Rebrickable: ${summary.to_add}</li>`;
                }
                if (summary.rate_limited_count !== undefined) {
                    html += `<li>Rate limited parts: ${summary.rate_limited_count}</li>`;
                }
                html += `</ul>`;
            }
            
            return html;
        }

        function formatUserSetsResult(data) {
            const summary = data.summary || {};
            let html = `<h6>User Sets Sync Complete</h6>`;
            
            if (summary.message) {
                html += `<p>${summary.message}</p>`;
            }
            
            // Handle rate limiting feedback
            if (summary.rate_limited_count && summary.rate_limited_count > 0) {
                html += `<div class="alert alert-warning mb-2">
                    <small><i class="bi bi-clock"></i> <strong>Rate Limited:</strong> 
                    ${summary.rate_limited_count} operations were rate limited by Rebrickable's API. 
                    These will be automatically synced during the next scheduled run (every 6 hours).</small>
                </div>`;
            }
            
            if (summary.local_sets_count !== undefined) {
                html += `<ul class="mb-0">`;
                html += `<li>Local unique sets: ${summary.local_sets_count}`;
                if (summary.local_total_quantity !== undefined) {
                    html += ` (total quantity: ${summary.local_total_quantity})`;
                }
                html += `</li>`;
                html += `<li>Sets on Rebrickable: ${summary.rebrickable_sets_count || 0}`;
                if (summary.rebrickable_total_quantity !== undefined) {
                    html += ` (total quantity: ${summary.rebrickable_total_quantity})`;
                }
                html += `</li>`;
                if (summary.sets_added !== undefined) {
                    html += `<li>Sets added: ${summary.sets_added}</li>`;
                }
                if (summary.sets_updated !== undefined) {
                    html += `<li>Quantities updated: ${summary.sets_updated}</li>`;
                }
                if (summary.sets_removed !== undefined) {
                    html += `<li>Sets removed: ${summary.sets_removed}</li>`;
                }
                if (summary.rate_limited_count !== undefined) {
                    html += `<li>Rate limited operations: ${summary.rate_limited_count}</li>`;
                }
                if (summary.list_created) {
                    html += `<li><strong>Created new "Brick_Manager" list</strong></li>`;
                }
                html += `</ul>`;
            }
            
            return html;
        }
    </script>
</body>

</html>