<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Missing Parts</title>
    
    
    <!-- Favicon -->
    {% include "favicon_links.html" %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        th.sortable {
            cursor: pointer;
        }

        th.sortable:hover {
            background-color: #f1f1f1;
        }

        .category-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .category-card.active {
            border-color: #0d6efd;
            background-color: #e7f3ff;
        }

        .loading-spinner {
            display: none;
        }

        .parts-section {
            display: none;
        }
        
        /* Page Loading Spinner */
        .page-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .page-loading-spinner {
            width: 3rem;
            height: 3rem;
            margin-bottom: 1rem;
        }
        
        .page-loading-text {
            font-size: 1.1rem;
            color: #6c757d;
            text-align: center;
        }
        
        .loading-progress {
            margin-top: 1rem;
            color: #6c757d;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <!-- Include the navigation bar -->
    {% include 'navbar.html' %}

    <!-- Page Loading Overlay -->
    <div id="pageLoadingOverlay" class="page-loading-overlay">
        <div class="spinner-border page-loading-spinner text-primary" role="status"></div>
        <div class="page-loading-text">
            <strong>Analyzing Missing Parts...</strong><br>
            <small>Processing inventory across all your sets</small>
            <div class="loading-progress">
                <small>This may take up to 15 seconds</small>
            </div>
        </div>
    </div>

    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Missing Items</h1>
        </div>

        <!-- Statistics Section -->
        {% if statistics %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Missing Parts Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h3 class="text-primary mb-1">{{ statistics.total_missing_parts }}</h3>
                                    <small class="text-muted">Total Missing Parts</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-success mb-1">{{ statistics.total_missing_regular_parts }}</h4>
                                    <small class="text-muted">Regular Parts</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-warning mb-1">{{ statistics.total_missing_spare_parts }}</h4>
                                    <small class="text-muted">Spare Parts</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    {% if statistics.has_filter %}
                                    <h4 class="text-info mb-1">{{ statistics.filtered_sets_count }}/{{ statistics.total_sets_checked }}</h4>
                                    <small class="text-muted">Filtered Sets</small>
                                    {% else %}
                                    <h4 class="text-info mb-1">{{ statistics.total_sets_checked }}</h4>
                                    <small class="text-muted">Total Sets</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% if statistics.has_filter %}
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-info-circle"></i> 
                                    <strong>Filtered View:</strong> Showing missing parts for {{ statistics.filtered_sets_count }} of {{ statistics.total_sets_checked }} sets based on internal ID filter: <code>{{ set_filter }}</code>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if categories %}
        <!-- Spare Parts Toggle - Always Visible -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="mb-1">Spare Parts Filter</h6>
                        <small class="text-muted">Toggle to include or exclude spare parts from all views</small>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="global-toggle-spare-parts" {% if include_spare %}checked{% endif %}>
                        <label class="form-check-label" for="global-toggle-spare-parts">
                            <span id="global-spare-parts-label">{% if include_spare %}Include Spare Parts{% else %}Exclude Spare Parts{% endif %}</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Set Filter - Always Visible -->
        <div class="card mb-4">
            <div class="card-body">
                <h6 class="mb-3">Internal ID Filter</h6>
                <small class="text-muted d-block mb-3">Filter missing parts by specific internal IDs (the number in the Internal ID column). Leave empty to show all sets.</small>
                
                <form method="GET" id="set-filter-form">
                    <div class="row">
                        <div class="col-md-8">
                            <input type="text" class="form-control" name="set_filter" id="set_filter_input" 
                                   value="{{ set_filter }}" placeholder="e.g. 229 or 200-220 or 200;204;205">
                            <input type="hidden" name="include_spare" value="{% if include_spare %}true{% else %}false{% endif %}">
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">Apply Filter</button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="clearSetFilter()">Clear</button>
                        </div>
                    </div>
                </form>
                
                <div class="mt-2">
                    <small class="text-muted">
                        <strong>Supported formats:</strong><br>
                        • Single internal ID: <code>229</code><br>
                        • Range: <code>200-220</code><br>
                        • List: <code>200;204;205</code> or <code>200,204,205</code><br>
                        • Mixed: <code>200-210;229;250-260</code>
                    </small>
                </div>
                
                {% if set_filter %}
                <div class="mt-3">
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-filter"></i> Currently filtering by internal IDs: <strong>{{ set_filter }}</strong>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- View Toggle -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="mb-1">View Mode</h6>
                        <small class="text-muted">Switch between grouped category view and complete list view</small>
                    </div>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="viewMode" id="categoryViewBtn" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="categoryViewBtn">
                            <i class="fas fa-th"></i> Category View
                        </label>
                        <input type="radio" class="btn-check" name="viewMode" id="listViewBtn" autocomplete="off">
                        <label class="btn btn-outline-primary" for="listViewBtn">
                            <i class="fas fa-list"></i> List View
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Overview Section -->
        <div id="category-overview">
            <h3>Categories with Missing Parts</h3>
            <p class="text-muted">Click on a category to view the missing parts in that category.</p>
            
            <div class="row" id="category-grid">
                {% for category in categories %}
                <div class="col-md-4 col-lg-3 mb-3">
                    <div class="card category-card" onclick="loadCategoryParts('{{ category.name }}')">
                        <div class="card-body text-center">
                            <h5 class="card-title">{{ category.name }}</h5>
                            <p class="card-text">
                                <span class="badge bg-primary">{{ category.count }} items</span><br>
                                <span class="badge bg-warning">{{ category.total_missing }} missing</span>
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            </div>
        </div>

        <!-- All Parts List View Section -->
        <div id="all-parts-list-section" class="parts-section mt-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>All Missing Parts - Complete List</h3>
            </div>

            <!-- Loading Spinner for List View -->
            <div id="list-loading-spinner" class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading all missing parts...</p>
            </div>

            <!-- All Parts Table -->
            <div id="all-parts-table-container" style="display: none;">
                <table id="all-missing-parts-table" class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th class="sortable" data-column="type" style="cursor: pointer;">Type <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-column="set_id" style="cursor: pointer;">Set ID <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-column="internal_id" style="cursor: pointer;">Internal ID <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-column="item_id" style="cursor: pointer;">Part Number <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-column="name" style="cursor: pointer;">Name <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-column="category" style="cursor: pointer;">Category <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-column="color" style="cursor: pointer;">Color <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-column="total_quantity" style="cursor: pointer;">Needed <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-column="have_quantity" style="cursor: pointer;">Have Quantity <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-column="location" style="cursor: pointer;">Location <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-column="is_spare" style="cursor: pointer;">Spare Part <i class="fas fa-sort"></i></th>
                        </tr>
                    </thead>
                    <tbody id="all-parts-table-body">
                        <!-- All parts will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Parts Details Section -->
        <div id="parts-section" class="parts-section mt-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 id="category-title">Category Parts</h3>
                <button class="btn btn-secondary" onclick="showCategoryOverview()">Back to Categories</button>
            </div>

            <!-- Loading Spinner -->
            <div id="loading-spinner" class="text-center loading-spinner">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading parts...</p>
            </div>

            <!-- Spare Parts Toggle -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">Spare Parts Filter</h6>
                            <small class="text-muted">Toggle to include or exclude spare parts from the results</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="toggle-spare-parts" checked>
                            <label class="form-check-label" for="toggle-spare-parts">
                                <span id="spare-parts-label">Include Spare Parts</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Parts Table -->
            <div id="parts-table-container">
                <table id="missing-parts-table" class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th class="sortable" data-column="type">Type</th>
                            <th class="sortable" data-column="set_id">Set ID</th>
                            <th class="sortable" data-column="internal_id">Internal ID</th>
                            <th class="sortable" data-column="item_id">Part Number</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Color</th>
                            <th class="sortable" data-column="total_quantity">Needed</th>
                            <th>Have Quantity</th>
                            <th>Location</th>
                            <th class="sortable" data-column="is_spare">Spare Part</th>
                        </tr>
                    </thead>
                    <tbody id="parts-table-body">
                        <!-- Parts will be loaded here via AJAX -->
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <!-- No Results Section -->
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="alert alert-warning text-center">
                    <h4><i class="fas fa-search"></i> No Missing Items Found</h4>
                    {% if set_filter %}
                    <p class="mb-3">No missing parts found for the specified internal ID filter: <strong>{{ set_filter }}</strong></p>
                    {% else %}
                    <p class="mb-3">Great news! You don't have any missing parts.</p>
                    {% endif %}
                </div>
                
                {% if set_filter %}
                <!-- Filter Modification Section -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-filter"></i> Modify Filter</h5>
                    </div>
                    <div class="card-body">
                        <form method="GET" class="mb-3">
                            <div class="row">
                                <div class="col-md-8">
                                    <label for="new_set_filter" class="form-label">Internal ID Filter:</label>
                                    <input type="text" class="form-control" name="set_filter" id="new_set_filter" 
                                           value="{{ set_filter }}" placeholder="e.g. 229 or 200-220 or 200;204;205">
                                    <input type="hidden" name="include_spare" value="{% if include_spare %}true{% else %}false{% endif %}">
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">Update Filter</button>
                                </div>
                            </div>
                        </form>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <a href="{{ url_for('missing_parts.missing_parts') }}?include_spare={% if include_spare %}true{% else %}false{% endif %}" 
                                   class="btn btn-outline-secondary w-100">
                                    <i class="fas fa-times"></i> Clear Filter & Show All
                                </a>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-info w-100" onclick="showFilterHelp()">
                                    <i class="fas fa-question-circle"></i> Filter Help
                                </button>
                            </div>
                        </div>
                        
                        <!-- Spare Parts Toggle -->
                        <div class="mt-3 p-3 bg-light rounded">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <strong>Spare Parts Filter:</strong>
                                    <small class="text-muted d-block">Include or exclude spare parts from results</small>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="no-results-spare-toggle" 
                                           {% if include_spare %}checked{% endif %} onchange="toggleSparePartsNoResults(this)">
                                    <label class="form-check-label" for="no-results-spare-toggle">
                                        {% if include_spare %}Include Spare Parts{% else %}Exclude Spare Parts{% endif %}
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filter Help (Initially Hidden) -->
                        <div id="filter-help" class="mt-3 p-3 bg-info text-white rounded" style="display: none;">
                            <h6><i class="fas fa-info-circle"></i> Filter Format Examples:</h6>
                            <ul class="mb-0">
                                <li><strong>Single ID:</strong> <code>229</code> - Shows parts from internal ID 229</li>
                                <li><strong>Range:</strong> <code>200-220</code> - Shows parts from internal IDs 200 to 220</li>
                                <li><strong>List:</strong> <code>200;204;205</code> - Shows parts from specific internal IDs</li>
                                <li><strong>Mixed:</strong> <code>200-210;229;250-260</code> - Combines ranges and individual IDs</li>
                            </ul>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="imageModalLabel">Part Image</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <img id="modalImage" src="" alt="" class="img-fluid" style="max-height: 70vh;" />
            <p id="modalImageName" class="mt-3 fw-bold"></p>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentCategoryParts = [];
        let currentCategoryName = null;
        let allPartsList = [];
        
        // Helper function to determine text color based on background color
        function getContrastColor(hexColor) {
            // Remove # if present
            const hex = hexColor.replace('#', '');
            
            // Convert to RGB
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            
            // Calculate luminance
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            
            // Return black for light colors, white for dark colors
            return luminance > 0.5 ? '#000000' : '#FFFFFF';
        }
        
        document.addEventListener('DOMContentLoaded', function () {
            const toggleSpareParts = document.getElementById('toggle-spare-parts');
            const globalToggleSpareParts = document.getElementById('global-toggle-spare-parts');

            // Set initial state from server
            {% if include_spare is defined %}
            const initialSpareState = {{ 'true' if include_spare else 'false' }};
            if (toggleSpareParts) {
                toggleSpareParts.checked = initialSpareState;
                const label = document.getElementById('spare-parts-label');
                if (label) {
                    label.textContent = toggleSpareParts.checked ? 'Include Spare Parts' : 'Exclude Spare Parts';
                }
            }
            if (globalToggleSpareParts) {
                globalToggleSpareParts.checked = initialSpareState;
                const globalLabel = document.getElementById('global-spare-parts-label');
                if (globalLabel) {
                    globalLabel.textContent = globalToggleSpareParts.checked ? 'Include Spare Parts' : 'Exclude Spare Parts';
                }
            }
            {% endif %}

            // Global Spare Parts Toggle - affects all views
            if (globalToggleSpareParts) {
                globalToggleSpareParts.addEventListener('change', function () {
                    // Update the label text based on toggle state
                    const label = document.getElementById('global-spare-parts-label');
                    label.textContent = this.checked ? 'Include Spare Parts' : 'Exclude Spare Parts';
                    
                    // Sync with details toggle
                    if (toggleSpareParts) {
                        toggleSpareParts.checked = this.checked;
                        const detailsLabel = document.getElementById('spare-parts-label');
                        if (detailsLabel) {
                            detailsLabel.textContent = this.checked ? 'Include Spare Parts' : 'Exclude Spare Parts';
                        }
                    }
                    
                    // Check which view is active and reload accordingly
                    const listViewBtn = document.getElementById('listViewBtn');
                    if (listViewBtn && listViewBtn.checked) {
                        // List view is active - reload list
                        loadAllPartsList();
                    } else if (currentCategoryName) {
                        // Category details view is active - reload category
                        loadCategoryParts(currentCategoryName);
                    } else {
                        // Category overview is active - reload overview
                        reloadCategoryOverview();
                    }
                });
            }

            // Details Spare Parts Toggle - reload category data when changed
            if (toggleSpareParts) {
                toggleSpareParts.addEventListener('change', function () {
                    // Update the label text based on toggle state
                    const label = document.getElementById('spare-parts-label');
                    if (label) {
                        label.textContent = this.checked ? 'Include Spare Parts' : 'Exclude Spare Parts';
                    }
                    
                    // Sync with global toggle
                    if (globalToggleSpareParts) {
                        globalToggleSpareParts.checked = this.checked;
                        const globalLabel = document.getElementById('global-spare-parts-label');
                        if (globalLabel) {
                            globalLabel.textContent = this.checked ? 'Include Spare Parts' : 'Exclude Spare Parts';
                        }
                    }
                    
                    if (currentCategoryName) {
                        // If we're viewing a category, reload it with new spare parts setting
                        loadCategoryParts(currentCategoryName);
                    } else {
                        // If we're in overview mode, reload the category overview
                        reloadCategoryOverview();
                    }
                });
            }

            // Setup view mode toggle
            const categoryViewBtn = document.getElementById('categoryViewBtn');
            const listViewBtn = document.getElementById('listViewBtn');
            
            if (categoryViewBtn) {
                categoryViewBtn.addEventListener('change', function() {
                    if (this.checked) {
                        showCategoryView();
                    }
                });
            }

            if (listViewBtn) {
                listViewBtn.addEventListener('change', function() {
                    if (this.checked) {
                        showListView();
                    }
                });
            }
        });

        function loadCategoryParts(categoryName) {
            // Track the current category
            currentCategoryName = categoryName;
            
            // Show loading spinner
            document.getElementById('category-overview').style.display = 'none';
            document.getElementById('parts-section').style.display = 'block';
            document.getElementById('loading-spinner').style.display = 'block';
            document.getElementById('parts-table-container').style.display = 'none';
            document.getElementById('category-title').textContent = categoryName + ' - Missing Parts';

            // Reset loading spinner content
            document.getElementById('loading-spinner').innerHTML = `
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading parts...</p>
            `;

            // Make AJAX request to get parts for this category
            // Get state from global toggle
            const globalToggle = document.getElementById('global-toggle-spare-parts');
            const detailsToggle = document.getElementById('toggle-spare-parts');
            const includeSpare = globalToggle ? globalToggle.checked : (detailsToggle ? detailsToggle.checked : true);
            
            // Get current set filter value
            const setFilterInput = document.getElementById('set_filter_input');
            const setFilter = setFilterInput ? setFilterInput.value.trim() : '';
            
            // Properly encode the category name for the URL
            const encodedCategoryName = encodeURIComponent(categoryName);
            let url = `/missing_parts_category/${encodedCategoryName}?include_spare=${includeSpare}`;
            
            // Add set filter if provided
            if (setFilter) {
                url += `&set_filter=${encodeURIComponent(setFilter)}`;
            }
            
            console.log('Loading category:', categoryName);
            console.log('URL:', url);
            
            fetch(url)
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data.length, 'items');
                    currentCategoryParts = data;
                    
                    // Only hide spinner and show table after successful data load
                    document.getElementById('loading-spinner').style.display = 'none';
                    document.getElementById('parts-table-container').style.display = 'block';
                    
                    renderPartsTable(data);
                })
                .catch(error => {
                    console.error('Error loading category parts:', error);
                    
                    // Only show error if we're still in loading state
                    if (document.getElementById('loading-spinner').style.display !== 'none') {
                        document.getElementById('loading-spinner').innerHTML = 
                            `<div class="alert alert-danger">
                                <h5>Error loading parts</h5>
                                <p>${error.message}</p>
                                <button class="btn btn-primary btn-sm" onclick="loadCategoryParts('${categoryName}')">Try Again</button>
                                <button class="btn btn-secondary btn-sm" onclick="showCategoryOverview()">Back to Categories</button>
                            </div>`;
                    }
                });
        }

        function showCategoryOverview() {
            // Clear current category when going back to overview
            currentCategoryName = null;
            
            document.getElementById('parts-section').style.display = 'none';
            document.getElementById('category-overview').style.display = 'block';
        }

        function showCategoryView() {
            document.getElementById('all-parts-list-section').style.display = 'none';
            document.getElementById('parts-section').style.display = 'none';
            document.getElementById('category-overview').style.display = 'block';
        }

        function showListView() {
            document.getElementById('category-overview').style.display = 'none';
            document.getElementById('parts-section').style.display = 'none';
            document.getElementById('all-parts-list-section').style.display = 'block';
            
            // Load all parts if not already loaded
            if (allPartsList.length === 0) {
                loadAllPartsList();
            }
        }

        function loadAllPartsList() {
            // Show loading spinner
            document.getElementById('list-loading-spinner').style.display = 'block';
            document.getElementById('all-parts-table-container').style.display = 'none';

            // Get spare parts filter state from global toggle
            const globalSpareToggle = document.getElementById('global-toggle-spare-parts');
            const includeSpare = globalSpareToggle ? globalSpareToggle.checked : true;
            
            // Get current set filter value
            const setFilterInput = document.getElementById('set_filter_input');
            const setFilter = setFilterInput ? setFilterInput.value.trim() : '';
            
            // Build URL
            let url = `/missing_parts_all?include_spare=${includeSpare}`;
            if (setFilter) {
                url += `&set_filter=${encodeURIComponent(setFilter)}`;
            }
            
            console.log('Loading all parts list, URL:', url);
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received all parts:', data.length, 'items');
                    allPartsList = data;
                    
                    // Hide spinner, show table
                    document.getElementById('list-loading-spinner').style.display = 'none';
                    document.getElementById('all-parts-table-container').style.display = 'block';
                    
                    renderAllPartsTable(data);
                })
                .catch(error => {
                    console.error('Error loading all parts:', error);
                    document.getElementById('list-loading-spinner').innerHTML = 
                        `<div class="alert alert-danger">
                            <h5>Error loading parts list</h5>
                            <p>${error.message}</p>
                            <button class="btn btn-primary btn-sm" onclick="loadAllPartsList()">Try Again</button>
                        </div>`;
                });
        }

        function renderAllPartsTable(parts) {
            const tbody = document.getElementById('all-parts-table-body');
            tbody.innerHTML = '';

            if (!parts || parts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center">No missing parts found</td></tr>';
                return;
            }

            console.log('Rendering table with', parts.length, 'parts');
            console.log('First part structure:', parts[0]);

            parts.forEach((part, index) => {
                const row = document.createElement('tr');
                
                // Color cell background using color_rgb (format: RRGGBB)
                const colorHex = part.color_rgb ? `#${part.color_rgb}` : '';
                const colorStyle = colorHex ? `background-color: ${colorHex}; color: ${getContrastColor(colorHex)};` : '';
                
                // Safely access all properties with fallbacks
                const imgUrl = part.img_url || '/static/default_image.png';
                const name = part.name || 'Unknown';
                const type = part.type || 'N/A';
                const setId = part.set_id || 'N/A';
                const internalId = part.internal_id || 'N/A';
                const itemId = part.item_id || 'N/A';
                const category = part.category || 'Unknown';
                const color = part.color || 'N/A';
                const totalQty = part.total_quantity || 0;
                const haveQty = part.have_quantity || 0;
                const location = part.location || 'Not stored';
                const isSpare = part.is_spare || false;
                const colorId = part.color_id || '';
                
                row.innerHTML = `
                    <td><img src="${imgUrl}" alt="${name}" style="max-width: 50px; cursor: pointer;" class="part-image-thumbnail" data-bs-toggle="modal" data-bs-target="#imageModal" data-img-url="${imgUrl}" data-part-name="${name}"></td>
                    <td>${type}</td>
                    <td>${setId}</td>
                    <td>${internalId}</td>
                    <td>${itemId}</td>
                    <td>${name}</td>
                    <td>${category}</td>
                    <td style="${colorStyle}">${color}</td>
                    <td>${totalQty}</td>
                    <td>
                        <input type="number" 
                               class="form-control form-control-sm have-quantity-input" 
                               value="${haveQty}"
                               min="0"
                               max="${totalQty}"
                               data-part-id="${itemId}"
                               data-set-id="${internalId}"
                               data-part-type="${type}"
                               data-is-spare="${isSpare}"
                               data-color-id="${colorId}"
                               data-index="${index}"
                               style="width: 80px;">
                    </td>
                    <td>${location}</td>
                    <td>${isSpare ? '<span class="badge bg-warning">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
                `;
                tbody.appendChild(row);
            });

            // Add event listeners to all input fields
            document.querySelectorAll('.have-quantity-input').forEach(input => {
                input.addEventListener('change', function() {
                    updatePartQuantityInList(this);
                });
            });

            // Add event listeners to all images for modal display
            document.querySelectorAll('.part-image-thumbnail').forEach(img => {
                img.addEventListener('click', function() {
                    const modalImage = document.getElementById('modalImage');
                    const modalImageName = document.getElementById('modalImageName');
                    modalImage.src = this.dataset.imgUrl;
                    modalImage.alt = this.dataset.partName;
                    modalImageName.textContent = this.dataset.partName;
                });
            });
        }

        function updatePartQuantityInList(inputElement) {
            const partId = inputElement.dataset.partId;
            const setId = inputElement.dataset.setId;
            const partType = inputElement.dataset.partType;
            const isSpare = inputElement.dataset.isSpare === 'true';
            const colorId = inputElement.dataset.colorId;
            const newQuantity = parseInt(inputElement.value);
            const index = parseInt(inputElement.dataset.index);

            // Update the part in our cached array
            if (allPartsList[index]) {
                const oldQuantity = allPartsList[index].have_quantity;
                const totalQuantity = allPartsList[index].total_quantity;
                allPartsList[index].have_quantity = newQuantity;

                // Send update to server
                fetch('/update_part_quantity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        part_id: partId,
                        set_id: parseInt(setId),
                        part_type: partType,
                        is_spare: isSpare,
                        color_id: parseInt(colorId),
                        have_quantity: newQuantity
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Quantity updated successfully');
                        // If quantity now matches or exceeds total, remove this part from the list
                        if (newQuantity >= totalQuantity) {
                            // Remove from cached array
                            allPartsList.splice(index, 1);
                            // Remove the row from the table without reloading
                            const row = inputElement.closest('tr');
                            if (row) {
                                row.style.transition = 'opacity 0.3s';
                                row.style.opacity = '0';
                                setTimeout(() => {
                                    row.remove();
                                    // Update remaining rows' indices
                                    updateRowIndices();
                                    // Show message if list is now empty
                                    if (allPartsList.length === 0) {
                                        const tbody = document.getElementById('all-parts-table-body');
                                        tbody.innerHTML = '<tr><td colspan="12" class="text-center">No missing parts found</td></tr>';
                                    }
                                }, 300);
                            }
                        }
                    } else {
                        console.error('Error updating quantity:', data.message);
                        alert('Error updating quantity: ' + (data.message || 'Unknown error'));
                        // Revert the value
                        inputElement.value = oldQuantity;
                        allPartsList[index].have_quantity = oldQuantity;
                    }
                })
                .catch(error => {
                    console.error('Error updating part quantity:', error);
                    alert('Error updating quantity. Please try again.');
                    // Revert the value
                    inputElement.value = oldQuantity;
                    allPartsList[index].have_quantity = oldQuantity;
                });
            }
        }

        function updateRowIndices() {
            // Update data-index attributes for all remaining rows
            document.querySelectorAll('.have-quantity-input').forEach((input, newIndex) => {
                input.dataset.index = newIndex;
            });
        }

        function reloadCategoryOverview() {
            // Get state from global toggle
            const globalToggle = document.getElementById('global-toggle-spare-parts');
            const includeSpare = globalToggle ? globalToggle.checked : true;
            
            // Get current set filter value
            const setFilterInput = document.getElementById('set_filter_input');
            const setFilter = setFilterInput ? setFilterInput.value.trim() : '';
            
            // Show loading spinner
            const categoryGrid = document.getElementById('category-grid');
            categoryGrid.innerHTML = `
                <div class="col-12 text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Updating categories...</p>
                </div>
            `;
            
            // Build URL with parameters
            let url = `/missing_parts_categories?include_spare=${includeSpare}`;
            if (setFilter) {
                url += `&set_filter=${encodeURIComponent(setFilter)}`;
            }
            
            // Fetch updated categories
            fetch(url)
                .then(response => response.json())
                .then(categories => {
                    // Re-render the category grid
                    let categoryHtml = '';
                    categories.forEach(category => {
                        categoryHtml += `
                            <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                                <div class="card category-card" onclick="loadCategoryParts('${category.name}')">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">${category.name}</h5>
                                        <p class="card-text">
                                            <span class="badge bg-primary">${category.count} items</span><br>
                                            <span class="badge bg-warning">${category.total_missing} missing</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    if (categories.length === 0) {
                        // Get current set filter for the message
                        const setFilterInput = document.getElementById('set_filter_input');
                        const currentFilter = setFilterInput ? setFilterInput.value.trim() : '';
                        
                        if (currentFilter) {
                            categoryHtml = `
                                <div class="col-12">
                                    <div class="alert alert-warning text-center">
                                        <h5><i class="fas fa-search"></i> No Missing Parts Found</h5>
                                        <p>No missing parts found for internal ID filter: <strong>${currentFilter}</strong></p>
                                        <div class="mt-3">
                                            <button class="btn btn-primary btn-sm me-2" onclick="document.getElementById('set_filter_input').focus()">
                                                <i class="fas fa-edit"></i> Modify Filter
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" onclick="clearSetFilter()">
                                                <i class="fas fa-times"></i> Clear Filter
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            categoryHtml = `
                                <div class="col-12 text-center">
                                    <div class="alert alert-success">
                                        <h5><i class="fas fa-check-circle"></i> Great News!</h5>
                                        <p class="text-muted">No missing parts found. Your collection is complete!</p>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    categoryGrid.innerHTML = categoryHtml;
                })
                .catch(error => {
                    console.error('Error reloading categories:', error);
                    categoryGrid.innerHTML = `
                        <div class="col-12 text-center">
                            <p class="text-danger">Error loading categories. Please refresh the page.</p>
                        </div>
                    `;
                });
        }

        function renderPartsTable(parts) {
            const tbody = document.getElementById('parts-table-body');
            tbody.innerHTML = '';

            if (parts.length === 0) {
                // Check if there's a filter applied
                const setFilterInput = document.getElementById('set_filter_input');
                const currentFilter = setFilterInput ? setFilterInput.value.trim() : '';
                
                if (currentFilter) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="12" class="text-center p-4">
                                <div class="alert alert-warning mb-0">
                                    <h6><i class="fas fa-search"></i> No Missing Parts Found in This Category</h6>
                                    <p class="mb-2">No missing parts found for internal ID filter: <strong>${currentFilter}</strong></p>
                                    <button class="btn btn-sm btn-primary me-2" onclick="showCategoryOverview()">
                                        <i class="fas fa-arrow-left"></i> Back to Categories
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="clearSetFilter()">
                                        <i class="fas fa-times"></i> Clear Filter
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="12" class="text-center p-4">
                                <div class="alert alert-success mb-0">
                                    <h6><i class="fas fa-check-circle"></i> No Missing Parts in This Category</h6>
                                    <p class="mb-2">Great! You have all parts for this category.</p>
                                    <button class="btn btn-sm btn-secondary" onclick="showCategoryOverview()">
                                        <i class="fas fa-arrow-left"></i> Back to Categories
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }
                return;
            }

            // Show a brief processing message
            if (parts.length > 50) {
                document.getElementById('loading-spinner').innerHTML = `
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <p>Processing ${parts.length} parts...</p>
                `;
                document.getElementById('loading-spinner').style.display = 'block';
                
                // Small delay to allow the processing message to show
                setTimeout(() => {
                    renderPartsTableContent(parts);
                    document.getElementById('loading-spinner').style.display = 'none';
                }, 100);
            } else {
                renderPartsTableContent(parts);
            }
        }

        function renderPartsTableContent(parts) {
            const tbody = document.getElementById('parts-table-body');
            
            parts.forEach(item => {
                const row = document.createElement('tr');
                row.className = `missing-item ${item.is_spare ? 'spare-part' : ''} ${item.status === 'Not Available' ? 'table-danger' : 'table-success'}`;
                
                const colorTextColor = parseInt(item.color_rgb, 16) > 0x888888 ? 'black' : 'white';
                
                row.innerHTML = `
                    <td>
                        <img src="${item.img_url}" alt="${item.name}" class="img-thumbnail" width="50" 
                             style="cursor: pointer;" onclick="showImageModal('${item.img_url}', '${item.name} (${item.item_id})')" 
                             onerror="this.src='/static/default_image.png'"
                             loading="lazy">
                    </td>
                    <td>${item.type}</td>
                    <td>${item.set_id}</td>
                    <td>${item.internal_id}</td>
                    <td>${item.item_id}</td>
                    <td>${item.name}</td>
                    <td>${item.category || 'Unknown Category'}</td>
                    <td style="background-color: #${item.color_rgb}; color: ${colorTextColor};">
                        ${item.color || 'Not Specified'}
                    </td>
                    <td>${item.total_quantity}</td>
                    <td>
                        <input type="number" class="form-control form-control-sm" 
                               value="${item.have_quantity || 0}" 
                               min="0" 
                               max="${item.total_quantity}"
                               data-part-id="${item.item_id}" 
                               data-set-id="${item.internal_id}"
                               data-part-type="${item.type}"
                               data-is-spare="${item.is_spare}"
                               data-color-id="${item.color_id || ''}"
                               data-total-quantity="${item.total_quantity}"
                               onchange="updateHaveQuantity(this)"
                               style="width: 80px;">
                    </td>
                    <td>${item.location}</td>
                    <td>${item.is_spare ? 'Yes' : 'No'}</td>
                `;
                
                tbody.appendChild(row);
            });

            // Reattach sorting functionality
            attachSortingHandlers();
        }

        function filterParts() {
            const includeSpare = document.getElementById('toggle-spare-parts').checked;
            const filteredParts = currentCategoryParts.filter(part => includeSpare || !part.is_spare);
            renderPartsTable(filteredParts);
        }

        function attachSortingHandlers() {
            const table = document.getElementById('missing-parts-table');
            const headers = table.querySelectorAll('th.sortable');
            
            headers.forEach(header => {
                header.addEventListener('click', function () {
                    const column = header.getAttribute('data-column');
                    const rows = Array.from(table.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none');
                    const isNumericColumn = ['set_id', 'internal_id', 'item_id', 'total_quantity'].includes(column);

                    const sortedRows = rows.sort((a, b) => {
                        const aValue = a.querySelector(`td:nth-child(${header.cellIndex + 1})`).innerText.trim();
                        const bValue = b.querySelector(`td:nth-child(${header.cellIndex + 1})`).innerText.trim();

                        if (isNumericColumn) {
                            return parseFloat(aValue) - parseFloat(bValue);
                        }

                        // Special handling for part numbers (alphanumeric sorting)
                        if (column === 'item_id') {
                            return aValue.localeCompare(bValue, undefined, { numeric: true, caseInsensitive: true });
                        }

                        return aValue.localeCompare(bValue);
                    });

                    // Append sorted rows
                    const tbody = table.querySelector('tbody');
                    tbody.innerHTML = '';
                    sortedRows.forEach(row => tbody.appendChild(row));
                });
            });
        }

        // Function to update category overview counts after parts are completed
        function updateCategoryOverviewCounts() {
            // This function could fetch updated counts from the server
            // For now, we'll just indicate that a refresh might be needed
            console.log('Category counts may need updating - consider refreshing the overview');
        }

        // Function to show image in modal
        function showImageModal(imageSrc, imageName) {
            document.getElementById('modalImage').src = imageSrc;
            document.getElementById('modalImageName').textContent = imageName;
            document.getElementById('imageModalLabel').textContent = imageName + ' - Image';
            var imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
            imageModal.show();
        }

        // Function to update have_quantity
        function updateHaveQuantity(input) {
            const partId = input.dataset.partId;
            const setId = input.dataset.setId;
            const partType = input.dataset.partType;
            const isSpare = input.dataset.isSpare === 'true';
            const colorId = input.dataset.colorId;
            const totalQuantity = parseInt(input.dataset.totalQuantity);
            const newQuantity = parseInt(input.value);
            
            if (isNaN(newQuantity) || newQuantity < 0) {
                alert('Please enter a valid quantity (0 or greater)');
                input.focus();
                return;
            }

            if (newQuantity > totalQuantity) {
                alert(`Cannot have more than ${totalQuantity} (needed quantity)`);
                input.value = totalQuantity;
                return;
            }

            // Show loading state
            input.disabled = true;
            const originalValue = input.value;
            
            // Prepare the update data with more specific identification
            const updateData = {
                part_id: partId,
                set_id: parseInt(setId),
                part_type: partType,
                is_spare: isSpare,
                color_id: colorId,
                have_quantity: newQuantity
            };

            console.log('Updating have_quantity:', updateData);

            // Make AJAX request to update the quantity
            fetch('/update_part_quantity', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    console.log('Successfully updated quantity');
                    
                    // Update row styling based on whether all parts are owned
                    const row = input.closest('tr');
                    const neededQuantity = totalQuantity;
                    const missingQuantity = neededQuantity - newQuantity;
                    
                    if (missingQuantity === 0) {
                        // Part is no longer missing - remove from table with animation
                        row.style.transition = 'opacity 0.5s ease-out';
                        row.style.opacity = '0.3';
                        row.style.backgroundColor = '#d4edda';
                        
                        // Show completion message briefly, then remove row
                        setTimeout(() => {
                            row.style.opacity = '0';
                            setTimeout(() => {
                                row.remove();
                                
                                // Check if table is now empty
                                const tbody = document.getElementById('parts-table-body');
                                if (tbody.children.length === 0) {
                                    tbody.innerHTML = '<tr><td colspan="12" class="text-center text-success"><strong>🎉 All parts completed for this category!</strong></td></tr>';
                                }
                                
                                // Update category count in overview (if we came from there)
                                updateCategoryOverviewCounts();
                            }, 500);
                        }, 1500);
                    } else {
                        row.classList.remove('table-success');
                        row.classList.add('table-danger');
                        row.style.opacity = '1';
                        row.style.backgroundColor = '';
                    }
                    
                    // Show success feedback
                    input.style.borderColor = '#28a745';
                    setTimeout(() => {
                        input.style.borderColor = '';
                    }, 1000);
                } else {
                    throw new Error(data.message || 'Failed to update quantity');
                }
            })
            .catch(error => {
                console.error('Error updating quantity:', error);
                alert(`Error updating quantity: ${error.message}`);
                // Reset the input value
                input.value = originalValue;
                input.style.borderColor = '#dc3545';
                setTimeout(() => {
                    input.style.borderColor = '';
                }, 3000);
            })
            .finally(() => {
                input.disabled = false;
            });
        }
        
        function clearSetFilter() {
            // Clear the input field
            document.getElementById('set_filter_input').value = '';
            
            // Submit the form to reload without the filter
            document.getElementById('set-filter-form').submit();
        }
        
        function showFilterHelp() {
            const helpElement = document.getElementById('filter-help');
            if (helpElement.style.display === 'none') {
                helpElement.style.display = 'block';
            } else {
                helpElement.style.display = 'none';
            }
        }
        
        function toggleSparePartsNoResults(checkbox) {
            // Get current filter value
            const setFilter = new URLSearchParams(window.location.search).get('set_filter') || '';
            const includeSpare = checkbox.checked;
            
            // Redirect with updated spare parts setting
            const url = new URL(window.location.href);
            url.searchParams.set('include_spare', includeSpare ? 'true' : 'false');
            if (setFilter) {
                url.searchParams.set('set_filter', setFilter);
            }
            
            window.location.href = url.toString();
        }
        
        // Page Loading Control
        window.addEventListener('load', function() {
            const loadingOverlay = document.getElementById('pageLoadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        });
        
        // Show spinner on navigation away or form submit
        window.addEventListener('beforeunload', function() {
            const loadingOverlay = document.getElementById('pageLoadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            }
        });
        
        // Show spinner when submitting forms (filters)
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', function() {
                    const loadingOverlay = document.getElementById('pageLoadingOverlay');
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'flex';
                    }
                });
            });

            // Add sorting functionality to table headers
            const sortableHeaders = document.querySelectorAll('#all-missing-parts-table .sortable');
            sortableHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.dataset.column;
                    sortTableByColumn(column, this);
                });
            });
        });

        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        function sortTableByColumn(column, headerElement) {
            // Toggle sort direction if clicking the same column
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            // Update all header icons
            document.querySelectorAll('#all-missing-parts-table .sortable i').forEach(icon => {
                icon.className = 'fas fa-sort';
            });

            // Update clicked header icon
            const icon = headerElement.querySelector('i');
            if (icon) {
                icon.className = currentSortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            }

            // Sort the allPartsList array
            allPartsList.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                // Handle null/undefined values
                if (valA === null || valA === undefined) valA = '';
                if (valB === null || valB === undefined) valB = '';

                // Handle boolean values (is_spare)
                if (typeof valA === 'boolean') {
                    valA = valA ? 1 : 0;
                    valB = valB ? 1 : 0;
                }

                // Handle numeric values
                if (typeof valA === 'number' && typeof valB === 'number') {
                    return currentSortDirection === 'asc' ? valA - valB : valB - valA;
                }

                // Handle string values (case insensitive)
                const strA = String(valA).toLowerCase();
                const strB = String(valB).toLowerCase();

                if (strA < strB) {
                    return currentSortDirection === 'asc' ? -1 : 1;
                }
                if (strA > strB) {
                    return currentSortDirection === 'asc' ? 1 : -1;
                }
                return 0;
            });

            // Re-render the table
            renderAllPartsTable(allPartsList);
        }

    </script>
</body>

</html>
