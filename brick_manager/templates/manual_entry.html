<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manual Entry - Add Part to Storage</title>
    
    <!-- Favicon -->
    {% include "favicon_links.html" %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    
    <style>
        .part-preview-card {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            display: none;
        }
        
        .part-preview-card.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .part-image-container {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .part-image-container img {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
        }
        
        .validation-spinner {
            display: none;
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .validation-icon {
            display: none;
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
        }
        
        .form-control-with-validation {
            position: relative;
        }
        
        .storage-exists-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-left: 4px solid #ffc107;
        }
        
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            border-radius: 10px;
        }
        
        .info-badge {
            display: inline-block;
            padding: 8px 15px;
            background: white;
            color: #667eea;
            border-radius: 20px;
            font-weight: 600;
            margin: 5px;
        }
        
        .parts-list-scroll {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: white;
        }
        
        .part-list-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            transition: background 0.2s;
        }
        
        .part-list-item:last-child {
            border-bottom: none;
        }
        
        .part-list-item:hover {
            background: #f8f9fa;
        }
        
        .part-list-item.invalid {
            background: #ffe6e6;
            opacity: 0.7;
        }
        
        .part-list-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-right: 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 5px;
            background: white;
        }
        
        .part-list-info {
            flex: 1;
        }
        
        .part-list-info h6 {
            margin: 0 0 5px 0;
            font-size: 0.95rem;
            color: #495057;
        }
        
        .part-list-info p {
            margin: 0;
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .part-list-badge {
            padding: 3px 8px;
            font-size: 0.75rem;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <!-- Include the navigation bar -->
    {% include 'navbar.html' %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <div class="container mt-5">
        <!-- Hero Section -->
        <div class="hero-section">
            <div class="text-center">
                <h1><i class="bi bi-box-seam"></i> Manual Part Entry</h1>
                <p class="lead mb-0">Add LEGO parts to your storage system</p>
            </div>
        </div>
        
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="alert-container">
            {% for category, message in messages %}
            <div class="alert alert-{{ 'success' if category == 'success' else 'warning' if category == 'warning' else 'danger' }} alert-dismissible fade show" role="alert">
                <i class="bi bi-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' if category == 'warning' else 'x-circle' }}"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <div class="row">
            <!-- Form Section -->
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-pencil-square"></i> Part Information</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" id="manual-entry-form">
                            <!-- Part Number(s) -->
                            <div class="mb-4 form-control-with-validation">
                                <label for="part_num" class="form-label">
                                    <i class="bi bi-hash"></i> Part Number(s) <span class="text-danger">*</span>
                                </label>
                                <div class="position-relative">
                                    <input type="text" 
                                           id="part_num" 
                                           name="part_num" 
                                           class="form-control form-control-lg" 
                                           placeholder="e.g., 3001 or 3001,3002,3003"
                                           value="{{ part_num }}"
                                           required 
                                           autofocus>
                                    <div class="validation-spinner">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                    <i class="validation-icon text-success bi bi-check-circle-fill" id="validIcon"></i>
                                    <i class="validation-icon text-danger bi bi-x-circle-fill" id="invalidIcon"></i>
                                </div>
                                <small class="form-text text-muted">Enter one or multiple part numbers separated by commas</small>
                            </div>

                            <hr>

                            <!-- Storage Location -->
                            <h6 class="mb-3"><i class="bi bi-geo-alt-fill"></i> Storage Location</h6>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="schrank" class="form-label">
                                        Schrank <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" 
                                           id="schrank" 
                                           name="schrank" 
                                           class="form-control" 
                                           placeholder="1"
                                           value="{{ schrank }}"
                                           min="1"
                                           required>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="fach" class="form-label">
                                        Fach <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" 
                                           id="fach" 
                                           name="fach" 
                                           class="form-control" 
                                           placeholder="1"
                                           value="{{ fach }}"
                                           min="1"
                                           required>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="box" class="form-label">
                                        Box <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" 
                                           id="box" 
                                           name="box" 
                                           class="form-control" 
                                           placeholder="1"
                                           value="{{ box }}"
                                           min="1"
                                           required>
                                </div>
                            </div>

                            <!-- Optional: Color ID (for tracking specific color variants) -->
                            <div class="mb-3">
                                <label for="color_id" class="form-label">
                                    <i class="bi bi-palette"></i> Color ID <small class="text-muted">(Optional)</small>
                                </label>
                                <input type="number" 
                                       id="color_id" 
                                       name="color_id" 
                                       class="form-control" 
                                       placeholder="e.g., 1 for White, 5 for Red"
                                       min="0">
                                <small class="form-text text-muted">Leave empty if color doesn't matter</small>
                            </div>

                            <!-- Optional: Notes -->
                            <div class="mb-3">
                                <label for="notes" class="form-label">
                                    <i class="bi bi-sticky"></i> Notes <small class="text-muted">(Optional)</small>
                                </label>
                                <input type="text" 
                                       id="notes" 
                                       name="notes" 
                                       class="form-control" 
                                       placeholder="e.g., spare parts, red variant, extra stock"
                                       maxlength="200">
                                <small class="form-text text-muted">Helps distinguish multiple storage locations for same part</small>
                            </div>

                            <!-- Hidden confirmation field -->
                            <input type="hidden" id="confirmed" name="confirmed" value="">
                            
                            <!-- Submit Button -->
                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                                    <i class="bi bi-save" id="saveIcon"></i> 
                                    <span class="spinner-border spinner-border-sm d-none" id="saveSpinner" role="status">
                                        <span class="visually-hidden">Saving...</span>
                                    </span>
                                    <span id="submitBtnText">Add to Storage</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Part Preview Section -->
            <div class="col-md-6">
                <div class="part-preview-card" id="partPreview">
                    <h5 class="text-center mb-4"><i class="bi bi-eye"></i> Part Preview</h5>
                    
                    <!-- Single Part View -->
                    <div id="singlePartView">
                        <!-- Part Image -->
                        <div class="part-image-container mb-4">
                            <img id="partImage" src="" alt="Part Image" style="display: none;">
                            <div id="noImagePlaceholder">
                                <i class="bi bi-image" style="font-size: 4rem; color: #ccc;"></i>
                                <p class="text-muted mt-2">No image available</p>
                            </div>
                        </div>
                        
                        <!-- Part Details -->
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-info-circle"></i> Part Details</h6>
                                <hr>
                                <p class="mb-2"><strong>Name:</strong> <span id="partName">-</span></p>
                                <p class="mb-2"><strong>Category:</strong> <span id="partCategory">-</span></p>
                                <p class="mb-0"><strong>Part Number:</strong> <span id="partNumber">-</span></p>
                            </div>
                        </div>
                        
                        <!-- Storage Warning -->
                        <div class="alert storage-exists-warning mt-3" id="storageWarning" style="display: none;">
                            <h6><i class="bi bi-exclamation-triangle"></i> <span id="storageWarningTitle">Existing Storage Location(s)</span></h6>
                            <p class="mb-2" id="storageWarningText">This part is already stored at:</p>
                            <div id="existingStorageList">
                                <!-- Will be populated dynamically -->
                            </div>
                            <p class="mb-0 mt-3"><small class="text-info"><i class="bi bi-info-circle"></i> You can add this part to a different location. Use Color ID or Notes to distinguish variants.</small></p>
                        </div>
                    </div>
                    
                    <!-- Multiple Parts List View -->
                    <div id="multiplePartsView" style="display: none;">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i> <strong><span id="validPartsCount">0</span> parts</strong> will be added to the same location
                        </div>
                        <div id="partsListContainer" class="parts-list-scroll">
                            <!-- Parts will be dynamically added here -->
                        </div>
                    </div>
                </div>
                
                <!-- Instructions Card (shown when no part is entered) -->
                <div class="card shadow-sm" id="instructionsCard">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-lightbulb"></i> How to Use</h5>
                        <hr>
                        <ol>
                            <li class="mb-2">Enter <strong>one or multiple Part Numbers</strong> (e.g., 3001 or 3001,3002,3003)</li>
                            <li class="mb-2">Wait for automatic validation - part info will appear</li>
                            <li class="mb-2">Enter the <strong>Storage Location</strong> (Schrank, Fach, Box)</li>
                            <li class="mb-2">Click <strong>Add to Storage</strong> to save all parts</li>
                        </ol>
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle"></i> <strong>Tip:</strong> You can add multiple parts to the same location by separating part numbers with commas!
                        </div>
                        <div class="alert alert-success mt-2">
                            <i class="bi bi-check-circle"></i> After saving, the box number will automatically increment for the next entry.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let validationTimeout = null;
        let partValidated = false;
        
        const partNumInput = document.getElementById('part_num');
        const submitBtn = document.getElementById('submitBtn');
        const partPreview = document.getElementById('partPreview');
        const instructionsCard = document.getElementById('instructionsCard');
        const validationSpinner = document.querySelector('.validation-spinner');
        const validIcon = document.getElementById('validIcon');
        const invalidIcon = document.getElementById('invalidIcon');
        const confirmedInput = document.getElementById('confirmed');
        
        let validatedParts = [];
        
        // Auto-validate part number(s) on input
        partNumInput.addEventListener('input', function() {
            const input = this.value.trim();
            
            // Reset validation state
            partValidated = false;
            submitBtn.disabled = true;
            validIcon.style.display = 'none';
            invalidIcon.style.display = 'none';
            partPreview.classList.remove('show');
            instructionsCard.style.display = 'block';
            validatedParts = [];
            
            if (input.length < 2) {
                validationSpinner.style.display = 'none';
                return;
            }
            
            // Clear previous timeout
            if (validationTimeout) {
                clearTimeout(validationTimeout);
            }
            
            // Show spinner
            validationSpinner.style.display = 'block';
            
            // Debounce validation request - wait 1.5 seconds after user stops typing
            validationTimeout = setTimeout(() => {
                // Check if comma-separated
                const partNumbers = input.split(',').map(p => p.trim()).filter(p => p.length > 0);
                
                if (partNumbers.length === 1) {
                    // Single part
                    validateSinglePart(partNumbers[0]);
                } else if (partNumbers.length > 1) {
                    // Multiple parts
                    validateMultipleParts(partNumbers);
                }
            }, 1500);
        });
        
        function validateSinglePart(partNum) {
            console.log('Validating single part:', partNum);
            fetch(`/manual_entry/validate_part/${partNum}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Validation response:', data);
                    validationSpinner.style.display = 'none';
                    
                    if (data.exists) {
                        // Part exists - show valid icon
                        validIcon.style.display = 'block';
                        partValidated = true;
                        submitBtn.disabled = false;
                        validatedParts = [{ partNum, data }];
                        
                        // Show single part view
                        document.getElementById('singlePartView').style.display = 'block';
                        document.getElementById('multiplePartsView').style.display = 'none';
                        
                        instructionsCard.style.display = 'none';
                        partPreview.classList.add('show');
                        
                        // Update part info
                        document.getElementById('partName').textContent = data.part_info.name;
                        document.getElementById('partCategory').textContent = data.part_info.category;
                        document.getElementById('partNumber').textContent = partNum;
                        
                        // Update image
                        const partImage = document.getElementById('partImage');
                        const noImagePlaceholder = document.getElementById('noImagePlaceholder');
                        
                        if (data.part_info.image_url) {
                            partImage.src = data.part_info.image_url;
                            partImage.style.display = 'block';
                            noImagePlaceholder.style.display = 'none';
                            
                            partImage.onerror = function() {
                                this.style.display = 'none';
                                noImagePlaceholder.style.display = 'block';
                            };
                        } else {
                            partImage.style.display = 'none';
                            noImagePlaceholder.style.display = 'block';
                        }
                        
                        // Show storage warning if exists
                        const storageWarning = document.getElementById('storageWarning');
                        if (data.has_storage && data.storage_list && data.storage_list.length > 0) {
                            storageWarning.style.display = 'block';
                            
                            // Update title based on count
                            const count = data.storage_count || 1;
                            document.getElementById('storageWarningTitle').textContent = 
                                count > 1 ? `${count} Existing Storage Locations` : 'Existing Storage Location';
                            document.getElementById('storageWarningText').textContent = 
                                count > 1 ? 'This part is already stored at:' : 'This part is already stored at:';
                            
                            // Build list of existing storage locations
                            const listContainer = document.getElementById('existingStorageList');
                            listContainer.innerHTML = '';
                            
                            data.storage_list.forEach((storage, index) => {
                                const div = document.createElement('div');
                                div.className = 'mb-2 p-2 border rounded bg-light d-flex justify-content-between align-items-center';
                                
                                let colorInfo = storage.color ? `<span class="badge bg-info">${storage.color}</span> ` : '';
                                let notesInfo = storage.notes ? `<span class="badge bg-secondary">${storage.notes}</span>` : '';
                                
                                div.innerHTML = `
                                    <div>
                                        <strong>Location ${index + 1}:</strong> ${colorInfo}${notesInfo}<br>
                                        <span class="info-badge">Schrank: ${storage.location}</span>
                                        <span class="info-badge">Fach: ${storage.level}</span>
                                        <span class="info-badge">Box: ${storage.box}</span>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-danger delete-storage-btn" 
                                            data-storage-id="${storage.id}"
                                            data-part-num="${partNum}"
                                            title="Delete this storage location">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                `;
                                listContainer.appendChild(div);
                            });
                        } else {
                            storageWarning.style.display = 'none';
                        }
                    } else {
                        invalidIcon.style.display = 'block';
                        alert('Part not found in Rebrickable database. Please check the part number.');
                    }
                })
                .catch(error => {
                    validationSpinner.style.display = 'none';
                    invalidIcon.style.display = 'block';
                    console.error('Validation error:', error);
                });
        }
        
        function validateMultipleParts(partNumbers) {
            console.log('Validating multiple parts:', partNumbers);
            
            const promises = partNumbers.map(partNum => 
                fetch(`/manual_entry/validate_part/${partNum}`)
                    .then(response => response.json())
                    .then(data => ({ partNum, data, valid: data.exists }))
                    .catch(error => {
                        console.error(`Error validating ${partNum}:`, error);
                        return { partNum, data: null, valid: false };
                    })
            );
            
            Promise.all(promises).then(results => {
                validationSpinner.style.display = 'none';
                validatedParts = results.filter(r => r.valid);
                
                if (validatedParts.length > 0) {
                    validIcon.style.display = 'block';
                    partValidated = true;
                    submitBtn.disabled = false;
                    
                    // Show multiple parts view
                    document.getElementById('singlePartView').style.display = 'none';
                    document.getElementById('multiplePartsView').style.display = 'block';
                    
                    instructionsCard.style.display = 'none';
                    partPreview.classList.add('show');
                    
                    // Update count
                    document.getElementById('validPartsCount').textContent = validatedParts.length;
                    
                    // Build parts list
                    const container = document.getElementById('partsListContainer');
                    container.innerHTML = '';
                    
                    results.forEach(result => {
                        const div = document.createElement('div');
                        div.className = `part-list-item ${result.valid ? '' : 'invalid'}`;
                        
                        if (result.valid) {
                            div.innerHTML = `
                                <img src="${result.data.part_info.image_url || '/static/default_image.png'}" 
                                     alt="${result.partNum}" 
                                     class="part-list-img"
                                     onerror="this.src='/static/default_image.png'">
                                <div class="part-list-info">
                                    <h6><strong>${result.partNum}</strong> - ${result.data.part_info.name}</h6>
                                    <p><span class="badge bg-secondary part-list-badge">${result.data.part_info.category}</span></p>
                                    ${result.data.has_storage ? 
                                        `<p class="text-warning"><small><i class="bi bi-exclamation-triangle"></i> Has existing storage location</small></p>` : 
                                        ''}
                                </div>
                                <div>
                                    <span class="badge bg-success">Valid</span>
                                </div>
                            `;
                        } else {
                            div.innerHTML = `
                                <div class="part-list-info">
                                    <h6><strong>${result.partNum}</strong></h6>
                                    <p class="text-danger"><i class="bi bi-x-circle"></i> Not found in database</p>
                                </div>
                                <div>
                                    <span class="badge bg-danger">Invalid</span>
                                </div>
                            `;
                        }
                        
                        container.appendChild(div);
                    });
                    
                    if (validatedParts.length !== results.length) {
                        const invalidCount = results.length - validatedParts.length;
                        alert(`${invalidCount} part number(s) not found and will be skipped.`);
                    }
                } else {
                    invalidIcon.style.display = 'block';
                    alert('None of the part numbers were found in the database.');
                }
            });
        }
        
        // Form submission with confirmation
        const form = document.getElementById('manual-entry-form');
        const saveIcon = document.getElementById('saveIcon');
        const saveSpinner = document.getElementById('saveSpinner');
        const submitBtnText = document.getElementById('submitBtnText');
        let skipValidation = false;
        let isSubmitting = false;
        
        form.addEventListener('submit', function(e) {
            // If we're re-submitting after confirmation, allow it
            if (skipValidation) {
                skipValidation = false;
                showSavingState();
                return true;
            }
            
            if (!partValidated) {
                e.preventDefault();
                alert('Please wait for part validation to complete.');
                return false;
            }
            
            // Prevent double submission
            if (isSubmitting) {
                e.preventDefault();
                return false;
            }
            
            // Show saving state (no confirmation needed - multiple storage locations are now supported)
            showSavingState();
            return true;
        });
        
        function showSavingState() {
            isSubmitting = true;
            submitBtn.disabled = true;
            saveIcon.style.display = 'none';
            saveSpinner.classList.remove('d-none');
            submitBtnText.textContent = 'Saving...';
            
            // Make form inputs readonly instead of disabled (disabled fields don't get submitted)
            const inputs = form.querySelectorAll('input:not([type="hidden"]):not([type="submit"])');
            inputs.forEach(input => input.readOnly = true);
            
            // Show overlay to prevent user interaction
            document.body.style.cursor = 'wait';
        }
        
        // Auto-focus on part number field
        window.onload = function() {
            partNumInput.focus();
        };

        // Delete storage location handler (using event delegation)
        document.addEventListener('click', function(e) {
            if (e.target.closest('.delete-storage-btn')) {
                const btn = e.target.closest('.delete-storage-btn');
                const storageId = btn.dataset.storageId;
                const partNum = btn.dataset.partNum;
                
                if (confirm(`Are you sure you want to delete this storage location?\n\nThis action cannot be undone.`)) {
                    // Disable button and show loading state
                    btn.disabled = true;
                    btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                    
                    fetch(`/manual_entry/delete_storage/${storageId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            // Remove the storage location div
                            btn.closest('.mb-2').remove();
                            
                            // Re-validate the part to update the storage list
                            const partNumField = document.getElementById('part_num');
                            if (partNumField.value === partNum) {
                                validateSinglePart(partNum);
                            }
                            
                            // Show success message
                            alert('Storage location deleted successfully!');
                        } else if (data.error) {
                            alert('Error: ' + data.error);
                            btn.disabled = false;
                            btn.innerHTML = '<i class="bi bi-trash"></i>';
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting storage:', error);
                        alert('An error occurred while deleting the storage location.');
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-trash"></i>';
                    });
                }
            }
        });
    </script>
</body>
</html>
