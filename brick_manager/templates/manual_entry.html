<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manual Entry - Add Part to Storage</title>
    
    <!-- Favicon -->
    {% include "favicon_links.html" %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    
    <style>
        .part-preview-card {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            display: none;
        }
        
        .part-preview-card.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .part-image-container {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .part-image-container img {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
        }
        
        .validation-spinner {
            display: none;
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .validation-icon {
            display: none;
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
        }
        
        .form-control-with-validation {
            position: relative;
        }
        
        .storage-exists-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-left: 4px solid #ffc107;
        }
        
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            border-radius: 10px;
        }
        
        .info-badge {
            display: inline-block;
            padding: 8px 15px;
            background: white;
            color: #667eea;
            border-radius: 20px;
            font-weight: 600;
            margin: 5px;
        }
    </style>
</head>

<body>
    <!-- Include the navigation bar -->
    {% include 'navbar.html' %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <div class="container mt-5">
        <!-- Hero Section -->
        <div class="hero-section">
            <div class="text-center">
                <h1><i class="bi bi-box-seam"></i> Manual Part Entry</h1>
                <p class="lead mb-0">Add LEGO parts to your storage system</p>
            </div>
        </div>
        
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="alert-container">
            {% for category, message in messages %}
            <div class="alert alert-{{ 'success' if category == 'success' else 'warning' if category == 'warning' else 'danger' }} alert-dismissible fade show" role="alert">
                <i class="bi bi-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' if category == 'warning' else 'x-circle' }}"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <div class="row">
            <!-- Form Section -->
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-pencil-square"></i> Part Information</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" id="manual-entry-form">
                            <!-- Part Number -->
                            <div class="mb-4 form-control-with-validation">
                                <label for="part_num" class="form-label">
                                    <i class="bi bi-hash"></i> Part Number <span class="text-danger">*</span>
                                </label>
                                <div class="position-relative">
                                    <input type="text" 
                                           id="part_num" 
                                           name="part_num" 
                                           class="form-control form-control-lg" 
                                           placeholder="e.g., 3001"
                                           value="{{ part_num }}"
                                           required 
                                           autofocus>
                                    <div class="validation-spinner">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                    <i class="validation-icon text-success bi bi-check-circle-fill" id="validIcon"></i>
                                    <i class="validation-icon text-danger bi bi-x-circle-fill" id="invalidIcon"></i>
                                </div>
                                <small class="form-text text-muted">Enter the part number to validate</small>
                            </div>

                            <hr>

                            <!-- Storage Location -->
                            <h6 class="mb-3"><i class="bi bi-geo-alt-fill"></i> Storage Location</h6>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="schrank" class="form-label">
                                        Schrank <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" 
                                           id="schrank" 
                                           name="schrank" 
                                           class="form-control" 
                                           placeholder="1"
                                           value="{{ schrank }}"
                                           min="1"
                                           required>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="fach" class="form-label">
                                        Fach <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" 
                                           id="fach" 
                                           name="fach" 
                                           class="form-control" 
                                           placeholder="1"
                                           value="{{ fach }}"
                                           min="1"
                                           required>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="box" class="form-label">
                                        Box <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" 
                                           id="box" 
                                           name="box" 
                                           class="form-control" 
                                           placeholder="1"
                                           value="{{ box }}"
                                           min="1"
                                           required>
                                </div>
                            </div>

                            <!-- Hidden confirmation field -->
                            <input type="hidden" id="confirmed" name="confirmed" value="">
                            
                            <!-- Submit Button -->
                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                                    <i class="bi bi-save" id="saveIcon"></i> 
                                    <span class="spinner-border spinner-border-sm d-none" id="saveSpinner" role="status">
                                        <span class="visually-hidden">Saving...</span>
                                    </span>
                                    <span id="submitBtnText">Add to Storage</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Part Preview Section -->
            <div class="col-md-6">
                <div class="part-preview-card" id="partPreview">
                    <h5 class="text-center mb-4"><i class="bi bi-eye"></i> Part Preview</h5>
                    
                    <!-- Part Image -->
                    <div class="part-image-container mb-4">
                        <img id="partImage" src="" alt="Part Image" style="display: none;">
                        <div id="noImagePlaceholder">
                            <i class="bi bi-image" style="font-size: 4rem; color: #ccc;"></i>
                            <p class="text-muted mt-2">No image available</p>
                        </div>
                    </div>
                    
                    <!-- Part Details -->
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title"><i class="bi bi-info-circle"></i> Part Details</h6>
                            <hr>
                            <p class="mb-2"><strong>Name:</strong> <span id="partName">-</span></p>
                            <p class="mb-2"><strong>Category:</strong> <span id="partCategory">-</span></p>
                            <p class="mb-0"><strong>Part Number:</strong> <span id="partNumber">-</span></p>
                        </div>
                    </div>
                    
                    <!-- Storage Warning -->
                    <div class="alert storage-exists-warning mt-3" id="storageWarning" style="display: none;">
                        <h6><i class="bi bi-exclamation-triangle"></i> Storage Location Already Exists</h6>
                        <p class="mb-2">This part already has a storage location:</p>
                        <div>
                            <span class="info-badge">Schrank: <span id="existingSchrank">-</span></span>
                            <span class="info-badge">Fach: <span id="existingFach">-</span></span>
                            <span class="info-badge">Box: <span id="existingBox">-</span></span>
                        </div>
                        <p class="mb-0 mt-3"><small>Submitting the form will overwrite the existing location.</small></p>
                    </div>
                </div>
                
                <!-- Instructions Card (shown when no part is entered) -->
                <div class="card shadow-sm" id="instructionsCard">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-lightbulb"></i> How to Use</h5>
                        <hr>
                        <ol>
                            <li class="mb-2">Enter the <strong>Part Number</strong> (e.g., 3001)</li>
                            <li class="mb-2">Wait for automatic validation - the part image will appear</li>
                            <li class="mb-2">Enter the <strong>Storage Location</strong> (Schrank, Fach, Box)</li>
                            <li class="mb-2">Click <strong>Add to Storage</strong> to save</li>
                        </ol>
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle"></i> <strong>Tip:</strong> After saving, the box number will automatically increment for the next entry!
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let validationTimeout = null;
        let partValidated = false;
        
        const partNumInput = document.getElementById('part_num');
        const submitBtn = document.getElementById('submitBtn');
        const partPreview = document.getElementById('partPreview');
        const instructionsCard = document.getElementById('instructionsCard');
        const validationSpinner = document.querySelector('.validation-spinner');
        const validIcon = document.getElementById('validIcon');
        const invalidIcon = document.getElementById('invalidIcon');
        const confirmedInput = document.getElementById('confirmed');
        
        // Auto-validate part number on input
        partNumInput.addEventListener('input', function() {
            const partNum = this.value.trim();
            
            // Reset validation state
            partValidated = false;
            submitBtn.disabled = true;
            validIcon.style.display = 'none';
            invalidIcon.style.display = 'none';
            partPreview.classList.remove('show');
            instructionsCard.style.display = 'block';
            
            if (partNum.length < 2) {
                validationSpinner.style.display = 'none';
                return;
            }
            
            // Clear previous timeout
            if (validationTimeout) {
                clearTimeout(validationTimeout);
            }
            
            // Show spinner
            validationSpinner.style.display = 'block';
            
            // Debounce validation request - wait 1.5 seconds after user stops typing
            validationTimeout = setTimeout(() => {
                validatePart(partNum);
            }, 1500);
        });
        
        function validatePart(partNum) {
            console.log('Validating part:', partNum);
            fetch(`/manual_entry/validate_part/${partNum}`)
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Validation response:', data);
                    validationSpinner.style.display = 'none';
                    
                    if (data.exists) {
                        // Part exists - show valid icon
                        validIcon.style.display = 'block';
                        partValidated = true;
                        submitBtn.disabled = false;
                        
                        // Show preview
                        instructionsCard.style.display = 'none';
                        partPreview.classList.add('show');
                        
                        // Update part info
                        document.getElementById('partName').textContent = data.part_info.name;
                        document.getElementById('partCategory').textContent = data.part_info.category;
                        document.getElementById('partNumber').textContent = partNum;
                        
                        // Update image
                        const partImage = document.getElementById('partImage');
                        const noImagePlaceholder = document.getElementById('noImagePlaceholder');
                        
                        if (data.part_info.image_url) {
                            partImage.src = data.part_info.image_url;
                            partImage.style.display = 'block';
                            noImagePlaceholder.style.display = 'none';
                            
                            // Handle image loading errors
                            partImage.onerror = function() {
                                this.style.display = 'none';
                                noImagePlaceholder.style.display = 'block';
                                console.log('Image failed to load:', data.part_info.image_url);
                            };
                        } else {
                            partImage.style.display = 'none';
                            noImagePlaceholder.style.display = 'block';
                        }
                        
                        // Show storage warning if exists
                        const storageWarning = document.getElementById('storageWarning');
                        if (data.has_storage && data.storage_info) {
                            storageWarning.style.display = 'block';
                            document.getElementById('existingSchrank').textContent = data.storage_info.location;
                            document.getElementById('existingFach').textContent = data.storage_info.level;
                            document.getElementById('existingBox').textContent = data.storage_info.box;
                        } else {
                            storageWarning.style.display = 'none';
                        }
                    } else {
                        // Part doesn't exist
                        invalidIcon.style.display = 'block';
                        alert('Part not found in Rebrickable database. Please check the part number.');
                    }
                })
                .catch(error => {
                    validationSpinner.style.display = 'none';
                    invalidIcon.style.display = 'block';
                    console.error('Validation error:', error);
                });
        }
        
        // Form submission with confirmation
        const form = document.getElementById('manual-entry-form');
        const saveIcon = document.getElementById('saveIcon');
        const saveSpinner = document.getElementById('saveSpinner');
        const submitBtnText = document.getElementById('submitBtnText');
        let skipValidation = false;
        let isSubmitting = false;
        
        form.addEventListener('submit', function(e) {
            // If we're re-submitting after confirmation, allow it
            if (skipValidation) {
                skipValidation = false;
                showSavingState();
                return true;
            }
            
            if (!partValidated) {
                e.preventDefault();
                alert('Please wait for part validation to complete.');
                return false;
            }
            
            // Prevent double submission
            if (isSubmitting) {
                e.preventDefault();
                return false;
            }
            
            // Check if storage exists and needs confirmation
            const storageWarning = document.getElementById('storageWarning');
            if (storageWarning.style.display === 'block' && confirmedInput.value !== 'yes') {
                e.preventDefault();
                
                const existingSchrank = document.getElementById('existingSchrank').textContent;
                const existingFach = document.getElementById('existingFach').textContent;
                const existingBox = document.getElementById('existingBox').textContent;
                
                if (confirm(`This part already exists in storage:\nSchrank: ${existingSchrank}, Fach: ${existingFach}, Box: ${existingBox}\n\nDo you want to overwrite it?`)) {
                    confirmedInput.value = 'yes';
                    skipValidation = true;
                    showSavingState();
                    form.submit();
                } else {
                    confirmedInput.value = '';
                }
                return false;
            }
            
            // Show saving state
            showSavingState();
            return true;
        });
        
        function showSavingState() {
            isSubmitting = true;
            submitBtn.disabled = true;
            saveIcon.style.display = 'none';
            saveSpinner.classList.remove('d-none');
            submitBtnText.textContent = 'Saving...';
            
            // Make form inputs readonly instead of disabled (disabled fields don't get submitted)
            const inputs = form.querySelectorAll('input:not([type="hidden"]):not([type="submit"])');
            inputs.forEach(input => input.readOnly = true);
            
            // Show overlay to prevent user interaction
            document.body.style.cursor = 'wait';
        }
        
        // Auto-focus on part number field
        window.onload = function() {
            partNumInput.focus();
        };
    </script>
</body>
</html>
